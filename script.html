<script>
  let recog_mute = true;
  let config = {};
  let ls_use = false;
  let now_translating = false;
  let now_displaying = false;
  let src_lang = "";
  const elms = {};
  const trans_q = new Queue();
  const disp_q = new Queue();
  const lang_iso639 = new Set(get_lang_iso639());
  const recognition = typeof SpeechRecognition !== "undefined"? new SpeechRecognition() : new webkitSpeechRecognition();

  // 表示
  const displaying = async() => {
    now_displaying = true;
    while(!disp_q.enpty()){
      const result = disp_q.get();
      let func = [];
      if(!config.recog_result_hidden && !config.interim_results){
        func.push(displaying_func(elms.display1, result.text, config.recog_prefix));
      }
      if(result[config.trans1_lang].code === 200){
        func.push(displaying_func(elms.display2, result[config.trans1_lang].result, config.trans1_prefix));
      }
      if(config.trans2_validity){
        if(result[config.trans2_lang].code === 200){
          func.push(displaying_func(elms.display3, result[config.trans2_lang].result, config.trans2_prefix));
        }
      }
      await Promise.all(func);
      await sleep(1000);
      if(!config.recog_result_hidden && !config.interim_results){
        elms.display1.value = "";
      }
      elms.display2.value = "";
      if(config.trans2_validity){
        elms.display3.value = "";
      }
      await sleep(100);
    }
    now_displaying = false;
  };

  // 翻訳
  const get_srclang = () => {
    if(lang_iso639.has(config.recognition_lang)){
      src_lang = cofnig.recognition_lang;
      return;
    }
    const lang = config.recognition_lang.split("-")[0];
    src_lang = lang_iso639.has(lang)? lang : "";
  };

  const gas_trans = async() => {
    now_translating = true;
    while(!trans_q.enpty()){
      const word = trans_q.get();
      
      let tgt = [config.trans1_lang];
      if(config.trans2_validity){
        tgt.push(config.trans2_lang);
      }

      const translated = await translate(word, tgt, src_lang);
      if(translated.status === 200){
       disp_q.put(translated);
       if(!now_displaying){
         displaying();
       }
      }

      let log_text = "";
      log_text += `[${translated.src}]${translated.text} → `;
      for(const lang of tgt){
        const result = translated[lang];
        if(result.code === 200){
          log_text += `[${lang}]${result.result}`;
        }else if(result.code === 400){
          log_text += `[${lang}]⚠なんらかのエラーで結果が返ってきませんでした`;
        }else if(result.code === 429){
          log_text += `[${lang}]⚠1日に翻訳できる回数の制限に到達しました`;
        }
      }
      elms.log_area.value = elms.log_area.value + log_text + "\n";
      elms.log_area.scrollTop = elms.log_area.scrollHeight;
    }
    now_translating = false;
  };

  // 音声認識
  const recog_start = () => {
    if(!recog_mute){
      recognition.interimResults = config.interim_results;
      recognition.lang = config.recognition_lang;
      recognition.continuous = config.recognition_mode;
      recognition.start();
    }
  };

  recognition.onstart = () => {
    elms.status.value = "待機中";
  };
  
  recognition.onspeechstart = () => {
    elms.status.value = "認識中";
  };

  recognition.onresult = async(event) => {
    if(!config.recog_result_hidden && config.interim_results){
      elms.display1.value = config.recog_prefix + event.results[event.resultIndex][0].transcript + " ";
      elms.display1.scrollLeft = elms.display1.scrollWidth;
    }
    if(event.results[event.resultIndex].isFinal){
      trans_q.put(event.results[event.resultIndex][0].transcript);
      if(!now_translating){
        gas_trans();
      }
      if(!config.recog_result_hidden && config.interim_results){
        await sleep(2000);
        if(elms.display1.value == config.recog_prefix + event.results[event.resultIndex][0].transcript + " "){
          elms.display1.value = "";
        }
      }
    }
  };

  recognition.onerror = () => {
    recognition.stop();
  };

  recognition.onend = () => {
    recog_start();
  };

  // elements取得
  const get_elms = () => {
    const ids = document.querySelectorAll("[id]");
    for(const id of ids){
      elms[id.id] = id;
    }
  };

  // local storage
  const ls_save = () => {
    const json = JSON.stringify(config);
    elms.config_json.value = json;
    if(ls_use){
      localStorage.setItem("TG_config", json);
    }
  };

  const ls_load = () => {
    const json = localStorage.getItem("TG_config");
    config = JSON.parse(json);
    if(!elms.config_json.value.length){
      elms.config_json.value = json;
    }
  };

  // config読み込み
  const load_config = () => {
    ls_use = localstorage_check();
    if(ls_use){
      ls_load();
      if(!config){
        config = defaultConfig;
        ls_save();
      }else{
        const marged = {...defaultConfig, ...config};
        marged.config_ver = defaultConfig.config_ver;
        config = marged;
        ls_save();
      }
      elms.localstorage_result.innerHTML = "設定はブラウザに保存されます";
    }else{
      config = defaultConfig;
      elms.localstorage_result.innerHTML = "このブラウザでは設定を保存できません";
      elms.localstorage_result.style.color = "red";
    }
  };


  // selectにオプションセット
  const set_select_menu = () => {
    const lang_select = document.getElementsByClassName("lang_select");
    const lang_list_sorted = [...langList].sort((a, b) => {
      const langA = a[0].toUpperCase();
      const langB = b[0].toUpperCase();
      if(langA < langB){
        return -1;
      }
      if(langA > langB){
        return 1;
      }
      return 0;
    });
    for(const elm of lang_select){
      for(const lang of lang_list_sorted){
        const opt = document.createElement("option");
        opt.value = lang[0];
        opt.innerHTML = `[${lang[0]}] ${lang[1]}`;
        elm.appendChild(opt);
      }
    }

    const font_select = document.getElementsByClassName("font_select");
    for(const elm of font_select){
      for(const [k, v] of Object.entries(fontList)){
        const opt = document.createElement("option");
        opt.value = k;
        opt.innerHTML = v[1];
        elm.appendChild(opt);
      }
    }
  };

  // スタイルの初期化
  const style_init = () => {
    for(const elm of Object.values(elms)){
      const value = config[elm.id];
      if(typeof value === "undefined"){
        continue;
      }else if(typeof value === "boolean"){
        elm.checked = value;
      }else{
        elm.value = value;
      }
    }

    elms.display_area.style.backgroundColor = config.background_color;

    for(const elm of document.getElementsByClassName("display_spacing")){
      elm.style.height = `${config.display_area_spacing}px`;
    }

    elms.display3.style.visibility = config.trans2_validity? "visible":"hidden";

    elms.display1.style.fontFamily = get_fontFamily(config.recog_font, config.recog_custom_font);
    elms.display2.style.fontFamily = get_fontFamily(config.trans1_font, config.trans1_custom_font);
    elms.display3.style.fontFamily = get_fontFamily(config.trans2_font, config.trans2_custom_font);
    elms.display1.style.color = config.recog_color;
    elms.display2.style.color = config.trans1_color;
    elms.display3.style.color = config.trans2_color;
    elms.display1.style.fontSize = `${config.recog_font_size}px`;
    elms.display2.style.fontSize = `${config.trans1_font_size}px`;
    elms.display3.style.fontSize = `${config.trans2_font_size}px`;
    elms.display1.style.textShadow = get_shadow(config.recog_shadow_size, config.recog_shadow_blur, config.recog_shadow_color);
    elms.display2.style.textShadow = get_shadow(config.trans1_shadow_size, config.trans1_shadow_blur, config.trans1_shadow_color);
    elms.display3.style.textShadow = get_shadow(config.trans2_shadow_size, config.trans2_shadow_blur, config.trans2_shadow_color);
    elms.display1.style.letterSpacing = `${config.recog_letter_space}px`;
    elms.display2.style.letterSpacing = `${config.trans1_letter_space}px`;
    elms.display3.style.letterSpacing = `${config.trans2_letter_space}px`;
    elms.display1.style.width = `${config.recog_area_width}px`;
    elms.display1.style.height = `${config.recog_area_height}px`;
    elms.display2.style.width = `${config.trans1_area_width}px`;
    elms.display2.style.height = `${config.trans1_area_height}px`;
    elms.display3.style.width = `${config.trans2_area_width}px`;
    elms.display3.style.height = config.trans2_validity? `${config.trans2_area_height}px`:"0px";

    elms.scroll_speed_value.innerHTML = elms.scroll_speed.value;
    elms.recog_shadow_size_value.innerHTML = elms.recog_shadow_size.value;
    elms.recog_shadow_blur_value.innerHTML = elms.recog_shadow_blur.value;
    elms.recog_letter_space_value.innerHTML = elms.recog_letter_space.value;
    elms.trans1_shadow_size_value.innerHTML = elms.trans1_shadow_size.value;
    elms.trans1_shadow_blur_value.innerHTML = elms.trans1_shadow_blur.value;
    elms.trans1_letter_space_value.innerHTML = elms.trans1_letter_space.value;
    elms.trans2_shadow_size_value.innerHTML = elms.trans2_shadow_size.value;
    elms.trans2_shadow_blur_value.innerHTML = elms.trans2_shadow_blur.value;
    elms.trans2_letter_space_value.innerHTML = elms.trans2_letter_space.value;
    elms.mute_button.value = recog_mute? "ミュート解除":"ミュート";
    elms.status.value = recog_mute? "ミュート中":"";
    elms.status.style.color = recog_mute? "red":"";

    elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
  };

  // イベントリスナー
  const add_event = () => {
    elms.mute_button.addEventListener("click", () => {
      if(recog_mute){
        elms.status.style.color = "";
        elms.status.value = "";
        recog_mute = false;
        elms.mute_button.value = "ミュート";
        recog_start();
      }else{
        recog_mute = true;
        recognition.stop();
        elms.status.value = "ミュート中";
        elms.status.style.color = "red";
        elms.mute_button.value = "ミュート解除";
      };
    });
    
    elms.log_clear.addEventListener("click", () => {
      elms.log_area.value = "";
    });

    elms.background_color.addEventListener("change", () => {
      config.background_color = elms.background_color.value;
      ls_save();
      elms.display_area.style.backgroundColor = config.background_color;
    });

    elms.display_area_color_validity.addEventListener("change", () => {
      for(const elm of document.getElementsByClassName("display_row")){
        if(elms.display_area_color_validity.checked){
          elm.style.backgroundColor = config.display_area_color;
        }else{
          elm.style.backgroundColor = "transparent";
        }
      }
    });

    elms.display_area_color.addEventListener("change", () => {
      config.display_area_color = elms.display_area_color.value;
      ls_save();
    });

    elms.display_area_dummy.addEventListener("click", () => {
      for(const elm of document.getElementsByClassName("display_row")){
        elm.value = "ABCDEFGabcdefgあいうえお阿伊宇江於";
      }
    });

    elms.display_area_dummy_clear.addEventListener("click", () => {
      for(const elm of document.getElementsByClassName("display_row")){
        elm.value = "";
      }
    });

    elms.recog_area_width.addEventListener("change", () => {
      if(elms.recog_area_width.value === ""){
        elms.recog_area_width.value = config.recog_area_width;
        return;
      }
      config.recog_area_width = to_number(elms.recog_area_width.value);
      ls_save();
      elms.display1.style.width = `${config.recog_area_width}px`;
    });

    elms.trans1_area_width.addEventListener("change", () => {
      if(elms.trans1_area_width.value === ""){
        elms.trans1_area_width.value = config.trans1_area_width;
        return;
      }
      config.trans1_area_width = to_number(elms.trans1_area_width.value);
      ls_save();
      elms.display2.style.width = `${config.trans1_area_width}px`;
    });

    elms.trans2_area_width.addEventListener("change", () => {
      if(elms.trans2_area_width.value === ""){
        elms.trans2_area_width.value = config.trans2_area_width;
        return;
      };
      config.trans2_area_width = to_number(elms.trans2_area_width.value);
      ls_save();
      elms.display3.style.width = `${config.trans2_area_width}px`;
    });

    elms.display_area_spacing.addEventListener("change", () => {
      if(elms.display_area_spacing.value === ""){
        elms.display_area_spacing.value = config.display_area_spacing;
        return;
      }
      config.display_area_spacing = to_number(elms.display_area_spacing.value);
      ls_save();
      for(const elm of document.getElementsByClassName("display_spacing")){
        elm.style.height = `${config.display_area_spacing}px`;
      }
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.scroll_speed.addEventListener("change", () => {
      config.scroll_speed = to_number(elms.scroll_speed.value);
      elms.scroll_speed_value.innerHTML = elms.scroll_speed.value;
      ls_save();
    });

    elms.recognition_mode.addEventListener("change", () => {
      config.recognition_mode = elms.recognition_mode.checked;
      ls_save();
      recognition.stop();
    });

    elms.recognition_lang.addEventListener("change", () => {
      config.recognition_lang = elms.recognition_lang.value;
      ls_save();
      get_srclang();
      recognition.stop();
    });

    elms.interim_results.addEventListener("change", () => {
      config.interim_results = elms.interim_results.checked;
      ls_save();
      recognition.stop();
    });

    elms.recog_result_hidden.addEventListener("change", () => {
      config.recog_result_hidden = elms.recog_result_hidden.checked;
      ls_save();
      recognition.stop();
    });

    elms.recog_font.addEventListener("change", () => {
      config.recog_font = elms.recog_font.value;
      elms.display1.style.fontFamily = get_fontFamily(config.recog_font, config.recog_custom_font);
      config.recog_area_height = get_textarea_height(config.recog_font_size, elms.display1.style.fontFamily);
      ls_save();
      elms.display1.style.height = `${config.recog_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.recog_color.addEventListener("change", () => {
      config.recog_color = elms.recog_color.value;
      ls_save();
      elms.display1.style.color = config.recog_color;
    });

    elms.recog_font_size.addEventListener("change", () => {
      if(elms.recog_font_size.value === ""){
        elms.recog_font_size.value = config.recog_font_size;
        return;
      }
      config.recog_font_size = to_number(elms.recog_font_size.value);
      config.recog_area_height = get_textarea_height(config.recog_font_size, elms.display1.style.fontFamily);
      ls_save();
      elms.display1.style.fontSize = `${config.recog_font_size}px`;
      elms.display1.style.height = `${config.recog_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.recog_shadow_size.addEventListener("change", () => {
      config.recog_shadow_size = to_number(elms.recog_shadow_size.value);
      ls_save();
      elms.recog_shadow_size_value.innerHTML = config.recog_shadow_size;
      elms.display1.style.textShadow = get_shadow(config.recog_shadow_size, config.recog_shadow_blur, config.recog_shadow_color);
    });

    elms.recog_shadow_blur.addEventListener("change", () => {
      config.recog_shadow_blur = to_number(elms.recog_shadow_blur.value);
      ls_save();
      elms.recog_shadow_blur_value.innerHTML = config.recog_shadow_blur;
      elms.display1.style.textShadow = get_shadow(config.recog_shadow_size, config.recog_shadow_blur, config.recog_shadow_color);
    });

    elms.recog_shadow_color.addEventListener("change", () => {
      config.recog_shadow_color = elms.recog_shadow_color.value;
      ls_save();
      elms.display1.style.textShadow = get_shadow(config.recog_shadow_size, config.recog_shadow_blur, config.recog_shadow_color);
    });

    elms.recog_letter_space.addEventListener("change", () => {
      config.recog_letter_space = to_number(elms.recog_letter_space.value);
      ls_save();
      elms.recog_letter_space_value.innerHTML = config.recog_letter_space;
      elms.display1.style.letterSpacing = `${config.recog_letter_space}px`;
    });

    elms.recog_custom_font.addEventListener("change", () => {
      config.recog_custom_font = elms.recog_custom_font.value;
      elms.display1.style.fontFamily = get_fontFamily(config.recog_font, config.recog_custom_font);
      config.recog_area_height = get_textarea_height(config.recog_font_size, elms.display1.style.fontFamily);
      ls_save();
      elms.display1.style.height = `${config.recog_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.recog_prefix.addEventListener("change", () => {
      config.recog_prefix = elms.recog_prefix.value;
      ls_save();
    });

    elms.trans1_lang.addEventListener("change", () => {
      config.trans1_lang = elms.trans1_lang.value;
      ls_save();
    });

    elms.trans1_font.addEventListener("change", () => {
      config.trans1_font = elms.trans1_font.value;
      elms.display2.style.fontFamily = get_fontFamily(config.trans1_font, config.trans1_custom_font);
      config.trans1_area_height = get_textarea_height(config.trans1_font_size, elms.display2.style.fontFamily);
      ls_save();
      elms.display2.style.height = `${config.trans1_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans1_color.addEventListener("change", () => {
      config.trans1_color = elms.trans1_color.value;
      ls_save();
      elms.display2.style.color = config.trans1_color;
    });

    elms.trans1_font_size.addEventListener("change", () => {
      if(elms.trans1_font_size.value === ""){
        elms.trans1_font_size.value = config.trans1_font_size;
        return;
      }
      config.trans1_font_size = to_number(elms.trans1_font_size.value);
      config.trans1_area_height = get_textarea_height(config.trans1_font_size, elms.display2.style.fontFamily);
      ls_save();
      elms.display2.style.fontSize = `${config.trans1_font_size}px`;
      elms.display2.style.height = `${config.trans1_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans1_shadow_size.addEventListener("change", () => {
      config.trans1_shadow_size = to_number(elms.trans1_shadow_size.value);
      ls_save();
      elms.trans1_shadow_size_value.innerHTML = config.trans1_shadow_size;
      elms.display2.style.textShadow = get_shadow(config.trans1_shadow_size, config.trans1_shadow_blur, config.trans1_shadow_color);
    });

    elms.trans1_shadow_blur.addEventListener("change", () => {
      config.trans1_shadow_blur = to_number(elms.trans1_shadow_blur.value);
      ls_save();
      elms.trans1_shadow_blur_value.innerHTML = config.trans1_shadow_blur;
      elms.display2.style.textShadow = get_shadow(config.trans1_shadow_size, config.trans1_shadow_blur, config.trans1_shadow_color);
    });

    elms.trans1_shadow_color.addEventListener("change", () => {
      config.trans1_shadow_color = elms.trans1_shadow_color.value;
      ls_save();
      elms.display2.style.textShadow = get_shadow(config.trans1_shadow_size, config.trans1_shadow_blur, config.trans1_shadow_color);
    });

    elms.trans1_letter_space.addEventListener("change", () => {
      config.trans1_letter_space = to_number(elms.trans1_letter_space.value);
      ls_save();
      elms.trans1_letter_space_value.innerHTML = config.trans1_letter_space
      elms.display2.style.letterSpacing = `${config.trans1_letter_space}px`;
    });

    elms.trans1_custom_font.addEventListener("change", () => {
      config.trans1_custom_font = elms.trans1_custom_font.value;
      elms.display2.style.fontFamily = get_fontFamily(config.trans1_font, config.trans1_custom_font);
      config.trans1_area_height = get_textarea_height(config.trans1_font_size, elms.display2.style.fontFamily);
      ls_save();
      elms.display2.style.height = `${config.trans1_area_height}px`;
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans1_prefix.addEventListener("change", () => {
      config.trans1_prefix = elms.trans1_prefix.value;
      ls_save();
    });

    elms.trans2_validity.addEventListener("change", () => {
      config.trans2_validity = elms.trans2_validity.checked;
      ls_save();
      elms.display3.style.visibility = config.trans2_validity? "visible":"hidden";
      elms.display3.style.height = config.trans2_validity? `${config.trans2_area_height}px`:"0px";
    })

    elms.trans2_lang.addEventListener("change", () => {
      config.trans2_lang = elms.trans2_lang.value;
      ls_save();
    });

    elms.trans2_font.addEventListener("change", () => {
      config.trans2_font = elms.trans2_font.value;
      elms.display3.style.fontFamily = get_fontFamily(config.trans2_font, config.trans2_custom_font);
      config.trans2_area_height = get_textarea_height(config.trans2_font_size, elms.display3.style.fontFamily);
      ls_save();
      elms.display3.style.height = config.trans2_validity? `${config.trans2_area_height}px`:"0px";
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans2_color.addEventListener("change", () => {
      config.trans2_color = elms.trans2_color.value;
      ls_save();
      elms.display3.style.color = config.trans2_color;
    });

    elms.trans2_font_size.addEventListener("change", () => {
      if(elms.trans2_font_size.value === ""){
        elms.trans2_font_size.value = config.trans2_font_size;
        return;
      }
      config.trans2_font_size = to_number(elms.trans2_font_size.value);
      config.trans2_area_height = get_textarea_height(config.trans2_font_size, elms.display3.style.fontFamily);
      ls_save();
      elms.display3.style.fontSize = `${config.trans2_font_size}px`;
      elms.display3.style.height = config.trans2_validity? `${config.trans2_area_height}px`:"0px";
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans2_shadow_size.addEventListener("change", () => {
      config.trans2_shadow_size = to_number(elms.trans2_shadow_size.value);
      ls_save();
      elms.trans2_shadow_size_value.innerHTML = config.trans2_shadow_size;
      elms.display3.style.textShadow = get_shadow(config.trans2_shadow_size, config.trans2_shadow_blur, config.trans2_shadow_color);
    });

    elms.trans2_shadow_blur.addEventListener("change", () => {
      config.trans2_shadow_blur = to_number(elms.trans2_shadow_blur.value);
      ls_save();
      elms.trans2_shadow_blur_value.innerHTML = config.trans2_shadow_blur;
      elms.display3.style.textShadow = get_shadow(config.trans2_shadow_size, config.trans2_shadow_blur, config.trans2_shadow_color);
    });

    elms.trans2_shadow_color.addEventListener("change", () => {
      config.trans2_shadow_color = elms.trans2_shadow_color.value;
      ls_save();
      elms.display3.style.textShadow = get_shadow(config.trans2_shadow_size, config.trans2_shadow_blur, config.trans2_shadow_color);
    });

    elms.trans2_letter_space.addEventListener("change", () => {
      config.trans2_letter_space = to_number(elms.trans2_letter_space.value);
      ls_save();
      elms.trans2_letter_space_value.innerHTML = config.trans2_letter_space
      elms.display3.style.letterSpacing = `${config.trans2_letter_space}px`;
    });

    elms.trans2_custom_font.addEventListener("change", () => {
      config.trans2_custom_font = elms.trans2_custom_font.value;
      elms.display3.style.fontFamily = get_fontFamily(config.trans2_font, config.trans2_custom_font);
      config.trans2_area_height = get_textarea_height(config.trans2_font_size, elms.display3.style.fontFamily);
      ls_save();
      elms.display3.style.height = config.trans2_validity? `${config.trans2_area_height}px`:"0px";
      elms.settings.style.marginTop = `${elms.display_area.offsetHeight}px`;
    });

    elms.trans2_prefix.addEventListener("change", () => {
      config.trans2_prefix = elms.trans2_prefix.value;
      ls_save();
    });

    elms.config_json.addEventListener("click", () => {
      elms.config_json.select();
    });

    elms.config_load_button.addEventListener("click", async () => {
      if(!elms.config_load.value.length){
        elms.config_load_result.innerHTML = "設定内容を入力してください";
        elms.config_load_result.style.color = "red";
        await sleep(3000);
        elms.config_load_result.innerHTML = "";
        return;
      }else{
        try{
          const json = JSON.parse(elms.config_load.value);
          config = {...defaultConfig, ...json};
          ls_save();
          elms.config_load_result.innerHTML = "設定を読み込みました。リロードします。";
          elms.config_load_result.style.color = "";
          await sleep(1000);
          location_reload();
        }catch(e){
          console.log(e);
          elms.config_load_result.innerHTML = "エラーが発生しました。";
          elms.config_load_result.style.color = "red";
          await sleep(3000);
          elms.config_load_result.innerHTML = "";
        }
      }
    });

    elms.reset_button.addEventListener("click", async () => {
      if(!elms.reset_check.checked){
        elms.reset_result.innerHTML = "リセットする場合はチェックボックスにチェックを入れて下さい";
        elms.reset_result.style.color = "red";
        await sleep(1000);
        elms.reset_result.innerHTML = "";
        return;
      }
      config = defaultConfig;
      ls_save();
      elms.reset_result.innerHTML = "リセットしました。リロードします。";
      elms.reset_result.style.color = "";
      await sleep(1000);
      location_reload();
    });
  };

  const main = () => {
    get_elms();
    load_config();
    set_select_menu();
    style_init();
    add_event();
    get_srclang();
    if(!recog_mute){
      recog_start();
    }
  };
  main();
</script>